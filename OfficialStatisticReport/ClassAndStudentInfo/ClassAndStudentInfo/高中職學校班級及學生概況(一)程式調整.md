# 高中職學校班級及學生概況(一)程式調整分析報告

## 專案概述
本專案是一個用於產生「高中職學校班級及學生概況（一）」統計報表的 C# Windows Forms 應用程式，主要功能是從資料庫中查詢學生資料並產生 Excel 報表。

## 程式架構分析

### 主要類別結構
1. **Program.cs** - 程式進入點，負責權限設定和 UI 初始化
2. **PrintBranch.cs** - 使用者介面表單，用於選擇部門和設定報表參數
3. **Printer.cs** - 核心業務邏輯類別，負責資料查詢和報表產生
4. **StudentObj.cs** - 學生資料物件
5. **GraduateStudentObj.cs** - 畢業生資料物件
6. **CompletionStudentObj.cs** - 修業生資料物件
7. **ReStudentObj.cs** - 重讀生資料物件
8. **SummaryRow.cs** - 統計資料物件（目前未使用）
9. **Permissions.cs** - 權限管理類別

## 程式流程分析

### 1. 程式啟動流程
```
Program.Main() 
→ 設定權限控制
→ 註冊功能按鈕點擊事件
→ 開啟 PrintBranch 表單
```

### 2. 報表產生流程
```
PrintBranch.btnPrint_Click()
→ Printer.Start()
→ BackgroundWorker 執行
→ 查詢學生資料
→ 資料清理和分類
→ 產生 Excel 報表
→ 儲存檔案
```

## 發現的問題與建議

### 🔴 嚴重問題

#### 1. SQL 注入風險
**位置**: `Printer.cs` 第 102 行
```csharp
sql = sql + " AND  dept.ref_dept_group_id in (" + Public_BranchID.Substring(0,Public_BranchID.Length-1)+ ")";
```
**問題**: 直接將使用者輸入的字串拼接到 SQL 查詢中，存在 SQL 注入風險。
**建議**: 使用參數化查詢或至少進行輸入驗證。

#### 2. 檔案儲存對話框過濾器錯誤
**位置**: `Printer.cs` 第 53 行
```csharp
sd.Filter = "Excel檔案 (*.xlsx)|*.xls|所有檔案 (*.*)|*.*";
```
**問題**: 檔案副檔名不一致，應該是 `*.xlsx` 而不是 `*.xls`。
**建議**: 修正為 `"Excel檔案 (*.xlsx)|*.xlsx|所有檔案 (*.*)|*.*"`

#### 3. 字串處理邏輯錯誤
**位置**: `Printer.cs` 第 194 行
```csharp
DeptName =k.Key.Substring(k.Key.Split('_')[0].Length+1,k.Key.Length-k.Key.Split('_')[0].Length-1);
```
**問題**: 複雜的字串處理邏輯，容易出錯且難以維護。
**建議**: 使用更簡潔的方式，如 `k.Key.Split('_')[1]`

### 🟡 中等等級問題

#### 4. 異常處理不完整
**位置**: `Printer.cs` 第 66-70 行
```csharp
catch
{
    // 空的 catch 區塊
}
```
**問題**: 空的 catch 區塊會隱藏所有異常，不利於除錯。
**建議**: 至少記錄異常資訊或重新拋出特定異常。

#### 5. 硬編碼的狀態值
**位置**: 多處使用硬編碼的狀態值如 "1", "2", "0" 等
**問題**: 缺乏常數定義，程式碼可讀性差。
**建議**: 定義常數類別來管理這些狀態值。

#### 6. 重複的程式碼
**位置**: `PrintBranch.cs` 中的按鈕啟用邏輯重複出現
**問題**: 相同的邏輯在多個事件處理器中重複。
**建議**: 提取為獨立方法。

### 🟢 輕微問題

#### 7. 未使用的類別
**位置**: `SummaryRow.cs`
**問題**: 定義了但未使用的類別。
**建議**: 如果不需要則刪除，或說明其用途。

#### 8. 註解掉的程式碼
**位置**: `Printer.cs` 第 262-302 行
**問題**: 大量註解掉的程式碼影響可讀性。
**建議**: 如果不需要則刪除，或說明保留原因。

#### 9. 變數命名不一致
**問題**: 中英文混合命名，如 `Public_BranchID` 和 `學生ID`。
**建議**: 統一命名規範。

## 程式邏輯檢查結果

### ✅ 正確的邏輯
1. **背景工作處理**: 使用 BackgroundWorker 避免 UI 凍結
2. **資料驗證**: CleanList 方法正確過濾異常資料
3. **科別分類**: SortToDept 方法正確按科別分組
4. **統計計算**: 各種計數方法邏輯正確

### ⚠️ 需要關注的邏輯
1. **年級判斷**: 延修生（狀態=2）的年級處理需要確認是否符合業務需求
2. **科別代碼查詢**: getDeptCode 方法的查詢邏輯可能需要優化
3. **重讀生查詢**: 時間條件和更新代碼的組合需要驗證

## 效能建議

1. **資料庫查詢優化**: 考慮使用 JOIN 減少查詢次數
2. **記憶體管理**: 大量資料處理時考慮分批處理
3. **Excel 產生**: 對於大量資料，考慮使用串流方式

## 安全性建議

1. **輸入驗證**: 對所有使用者輸入進行驗證
2. **SQL 注入防護**: 使用參數化查詢
3. **檔案路徑驗證**: 驗證檔案儲存路徑的安全性

## 維護性建議

1. **程式碼重構**: 提取重複邏輯為獨立方法
2. **常數管理**: 建立常數類別管理硬編碼值
3. **錯誤處理**: 完善異常處理機制
4. **單元測試**: 為核心業務邏輯添加單元測試

## 總結

整體而言，程式的基本功能邏輯是正確的，但在安全性、錯誤處理和程式碼品質方面有改進空間。建議優先處理 SQL 注入風險和檔案過濾器錯誤，然後逐步改善程式碼的可維護性。

---
*分析日期: 2025年12月*
*分析範圍: 完整程式碼審查*